name: Deploy Backend

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r src/requirements.txt -t src/lambdas/common

      - name: Package Lambda functions
        run: |
          zip -r authorizer.zip src/lambdas/authorizer
          zip -r wrapped.zip src/lambdas/wrapped
          zip -r xomify-shared-packages.zip src/lambdas/common

      - name: Deploy Lambda Layer
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
        run: |
          aws lambda publish-layer-version \
            --layer-name xomify-shared-packages \
            --zip-file fileb://xomify-shared-packages.zip \
            --compatible-runtimes python3.10

      - name: Deploy Authorizer Lambda
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
        run: |
          aws lambda update-function-code \
            --function-name xomify-authorizer \
            --zip-file fileb://authorizer.zip

      - name: Deploy Wrapped Lambda
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
        run: |
          aws lambda update-function-code \
            --function-name xomify-wrapped \
            --zip-file fileb://wrapped.zip
